# Makefile for clioserv-router and clioserv-webserver
# Located in exploitation/ and intended to be run from here.

# ------------------------------
# Platform detection
# ------------------------------
ifeq ($(OS),Windows_NT)
    EXE := .exe
else
    EXE :=
endif

# ------------------------------
# Paths
# ------------------------------
PROJECT_ROOT := ..
COMMON := $(PROJECT_ROOT)/common
DEPS := $(COMMON)/dependencies
UTILS := $(COMMON)/src/utils
PROMPTS := $(COMMON)/src/prompts
ROUTER := $(PROJECT_ROOT)/router/src
WEBSERVER := $(PROJECT_ROOT)/webserver/src
BIN_DIR := .

# ------------------------------
# Compiler + Flags
# ------------------------------
CC := gcc
CFLAGS := -Wall -Wextra -g

# Includes
INC := -I$(DEPS)/mongoose -I$(UTILS) -I$(DEPS)/cJSON -I$(PROMPTS)

# ------------------------------
# Sources
# ------------------------------
ROUTER_SRCS := $(ROUTER)/main.c \
               $(DEPS)/mongoose/mongoose.c \
			   $(UTILS)/utils.c

WEBSERVER_SRCS := $(WEBSERVER)/main.c \
                  $(WEBSERVER)/html_renderer.c \
				  $(WEBSERVER)/events_handler.c \
                  $(DEPS)/mongoose/mongoose.c \
				  $(DEPS)/cJSON/cJSON.c \
                  $(UTILS)/utils.c \
				  $(PROMPTS)/prompts.c

# ------------------------------
# Output binaries
# ------------------------------
ROUTER_BIN := $(BIN_DIR)/clioserv-router$(EXE)
WEBSERVER_BIN := $(BIN_DIR)/clioserv-webserver$(EXE)

# ------------------------------
# Colors
# ------------------------------
GREEN := \033[1;32m
BLUE := \033[1;34m
RED := \033[1;31m
RESET := \033[0m

# ------------------------------
# Rules
# ------------------------------
all: router webserver

router:
	@echo "[$(BLUE)ROUTER$(RESET)] Compilation en cours..."
	$(CC) $(CFLAGS) $(ROUTER_SRCS) -o $(ROUTER_BIN) $(INC)
	@echo "[$(GREEN)ROUTER OK → $(ROUTER_BIN)$(RESET)]"

webserver:
	@echo "[$(BLUE)WEBSERVER$(RESET)] Compilation en cours..."
	$(CC) $(CFLAGS) $(WEBSERVER_SRCS) -o $(WEBSERVER_BIN) $(INC)
	@echo "[$(GREEN)WEBSERVER OK → $(WEBSERVER_BIN)$(RESET)]"

clean:
	@echo "[$(RED)CLEAN$(RESET)] Suppression des binaires"
	rm -f $(ROUTER_BIN) $(WEBSERVER_BIN)

re: clean all

.PHONY: all router webserver clean re
